{% extends "base.html" %}

{% block title %}대시보드 - {{ super() }}{% endblock %}

{% block content %}
<div>
    <!-- Page header -->
    <div class="border-b border-white/10 pb-5">
        <h1 class="text-2xl font-semibold text-white">대시보드</h1>
        <p class="mt-2 text-sm text-gray-400">시스템 상태와 최근 활동을 한눈에 확인하세요.</p>
    </div>
    
    <!-- Quick Stats -->
    <div class="mt-8 grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4">
        <div class="rounded-lg bg-white/5 p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                        </svg>
                    </div>
                <div class="ml-4 flex-1">
                    <p class="text-sm font-medium text-gray-400">총 다운로드</p>
                    <p class="text-2xl font-semibold text-white" id="total-downloads">-</p>
                </div>
            </div>
        </div>
        <div class="rounded-lg bg-white/5 p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                <div class="ml-4 flex-1">
                    <p class="text-sm font-medium text-gray-400">완료된 다운로드</p>
                    <p class="text-2xl font-semibold text-white" id="completed-downloads">-</p>
                </div>
            </div>
        </div>
        <div class="rounded-lg bg-white/5 p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.664 0l3.181-3.183m-4.991-2.696a8.25 8.25 0 00-11.664 0m11.664 0l-3.181 3.183" />
                        </svg>
                    </div>
                <div class="ml-4 flex-1">
                    <p class="text-sm font-medium text-gray-400">진행 중</p>
                    <p class="text-2xl font-semibold text-white" id="active-downloads">-</p>
                </div>
            </div>
        </div>
        <div class="rounded-lg bg-white/5 p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 6.375l-4.243 4.242-4.242-4.242-4.243 4.242-4.242-4.242L2.25 15.625" />
                        </svg>
                    </div>
                <div class="ml-4 flex-1">
                    <p class="text-sm font-medium text-gray-400">사용된 저장공간</p>
                    <p class="text-2xl font-semibold text-white" id="storage-used">-</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main grid -->
    <div class="mt-8 grid grid-cols-1 gap-8 lg:grid-cols-3">
        <!-- Recent Downloads -->
        <div class="lg:col-span-2">
            <div class="rounded-lg bg-gray-800/50 shadow">
                <div class="px-6 py-4 border-b border-white/10">
                    <h3 class="text-base font-semibold leading-6 text-white">최근 다운로드</h3>
                </div>
                <div class="p-6">
                    <div id="recent-downloads">
                        <!-- Content will be loaded dynamically -->
                        <div class="text-center py-8 text-gray-400">
                            <svg class="w-12 h-12 mx-auto mb-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                    </svg>
                            <p class="mt-2 text-sm">아직 다운로드가 없습니다</p>
                            <a href="/download" class="mt-4 inline-flex items-center rounded-md bg-indigo-500 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-500">
                                첫 다운로드 시작하기
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- System Status & Recent Activity -->
        <div class="space-y-8">
            <div class="rounded-lg bg-gray-800/50 shadow">
                <div class="px-6 py-4 border-b border-white/10">
                    <h3 class="text-base font-semibold leading-6 text-white">시스템 상태</h3>
            </div>
                <div class="p-6">
                    <div class="space-y-4" id="system-status">
                        <!-- Status will be loaded dynamically -->
                    <div class="animate-pulse">
                            <div class="flex items-center justify-between py-1">
                                <div class="h-4 bg-gray-700 rounded w-24"></div>
                                <div class="h-4 bg-gray-700 rounded w-16"></div>
                            </div>
                            <div class="flex items-center justify-between py-1">
                                <div class="h-4 bg-gray-700 rounded w-20"></div>
                                <div class="h-4 bg-gray-700 rounded w-20"></div>
                        </div>
                            <div class="flex items-center justify-between py-1">
                                <div class="h-4 bg-gray-700 rounded w-28"></div>
                                <div class="h-4 bg-gray-700 rounded w-12"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="rounded-lg bg-gray-800/50 shadow">
                <div class="px-6 py-4 border-b border-white/10">
                    <h3 class="text-base font-semibold leading-6 text-white">최근 활동</h3>
        </div>
                <div class="p-6">
                    <div class="space-y-3" id="recent-activity">
                        <!-- Activity will be loaded dynamically -->
                        <div class="animate-pulse">
                            <div class="flex items-center space-x-3 py-1">
                                <div class="w-8 h-8 bg-gray-700 rounded-full"></div>
                                <div class="flex-1 space-y-2">
                                    <div class="h-4 bg-gray-700 rounded w-3/4"></div>
                                    <div class="h-3 bg-gray-700 rounded w-1/2"></div>
            </div>
        </div>
                            <div class="flex items-center space-x-3 py-1">
                                <div class="w-8 h-8 bg-gray-700 rounded-full"></div>
                                <div class="flex-1 space-y-2">
                                    <div class="h-4 bg-gray-700 rounded w-2/3"></div>
                                    <div class="h-3 bg-gray-700 rounded w-1/3"></div>
            </div>
        </div>
            </div>
        </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Utility function to create badge ---
        function createBadge(type, text) {
            const badge = document.createElement('span');
            let baseClasses = 'inline-flex items-center rounded-md px-2 py-1 text-xs font-medium ring-1 ring-inset ';
            if (type === 'success') {
                badge.className = baseClasses + 'bg-green-500/10 text-green-400 ring-green-500/20';
            } else if (type === 'warning') {
                badge.className = baseClasses + 'bg-yellow-500/10 text-yellow-400 ring-yellow-500/20';
            } else {
                badge.className = baseClasses + 'bg-red-500/10 text-red-400 ring-red-500/20';
            }
            badge.textContent = text;
            return badge.outerHTML;
        }

        // --- Load Dashboard Data ---
        async function loadSystemStatus() {
            try {
                const response = await fetch('/status');
                const data = await response.json();
                
                const statusContainer = document.getElementById('system-status');
                statusContainer.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-300">시스템</span>
                        ${createBadge(data.system.status === 'healthy' ? 'success' : 'danger', data.system.status === 'healthy' ? '정상' : '오류')}
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-300">인증 상태</span>
                        ${createBadge(data.auth.authenticated ? 'success' : 'warning', data.auth.authenticated ? '로그인됨' : '로그인 필요')}
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-300">다운로드 경로</span>
                        ${createBadge(data.download.download_path_status === 'ok' ? 'success' : 'danger', data.download.download_path_status === 'ok' ? '정상' : '오류')}
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-300">활성 배치</span>
                        <span class="text-sm text-white">${data.download.active_batches}개</span>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading system status:', error);
                document.getElementById('system-status').innerHTML = '<p class="text-red-400">상태를 불러오는 데 실패했습니다.</p>';
            }
        }

        async function loadRecentActivity() {
            // This function seems to be missing in the original file, 
            // but I'm adding a placeholder based on the HTML.
            document.getElementById('recent-activity').innerHTML = '<p class="text-sm text-gray-400">최근 활동이 없습니다.</p>';
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/download/stats');
                const data = await response.json();
                document.getElementById('total-downloads').textContent = data.total;
                document.getElementById('completed-downloads').textContent = data.completed;
                document.getElementById('active-downloads').textContent = data.active;
                document.getElementById('storage-used').textContent = data.storage_used;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        function renderRecentDownloads(downloads) {
            const container = document.getElementById('recent-downloads');
            if (!downloads || downloads.length === 0) {
                container.innerHTML = '<li><div class="text-center py-4 text-sm text-gray-500">최근 완료된 항목이 없습니다.</div></li>';
                return;
            }
            
            let content = downloads.map(item => `
                <li class="flex items-center justify-between gap-x-6 py-3">
                    <div class="flex min-w-0 items-center gap-x-4">
                        <svg class="h-8 w-8 flex-shrink-0 text-green-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd"></path></svg>
                        <div class="min-w-0">
                            <p class="text-sm font-semibold leading-6 text-white">${item.filename || 'Unknown File'}</p>
                            <p class="mt-1 truncate text-xs leading-5 text-gray-400">'${item.batch_name || 'Untitled Batch'}'에서</p>
                        </div>
                    </div>
                    <div class="flex flex-none items-center gap-x-4">
                        <span class="hidden sm:inline-block text-sm text-gray-400">${item.human_readable_size || ''}</span>
                    </div>
                </li>
            `).join('');
            container.innerHTML = content;
        }

        async function loadRecentDownloads() {
            try {
                const response = await fetch('/api/download/recent');
                const downloads = await response.json();
                renderRecentDownloads(downloads);
            } catch (error) {
                console.error('Error loading recent downloads:', error);
            }
        }

        // --- Initial Load & SSE ---
        loadSystemStatus();
        loadRecentActivity();
        loadStats();
        loadRecentDownloads();

        const dashES = new EventSource('/api/download/stream');
        dashES.onmessage = (e) => {
            try {
                loadStats();
                loadRecentDownloads();
            } catch (err) {
                console.error('dash refresh error', err);
            }
        };
        window.addEventListener('beforeunload', () => dashES.close());
        
        setInterval(() => {
            loadSystemStatus();
            loadStats();
        }, 30000);
    });
</script>
{% endblock %}