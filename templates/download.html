{% extends "base.html" %}

{% block title %}Downloader - Super Rapidgator{% endblock %}

{% block content %}
<div class="px-4 sm:px-6 lg:px-8 py-8">
    <div class="sm:flex sm:items-center">
        <div class="sm:flex-auto">
            <h1 class="text-base font-semibold leading-6 text-white">Downloader</h1>
            <p class="mt-2 text-sm text-gray-300">Add Rapidgator URLs to start downloading.</p>
        </div>
    </div>

    <!-- URL Input Form -->
    <div class="mt-8">
        <form id="download-form">
            <div>
                <label for="urls" class="block text-sm font-medium leading-6 text-white">Rapidgator URLs</label>
                <div class="mt-2">
                    <textarea rows="4" name="urls" id="urls" class="block w-full rounded-md border-0 bg-white/5 py-1.5 text-white shadow-sm ring-1 ring-inset ring-white/10 focus:ring-2 focus:ring-inset focus:ring-indigo-500 sm:text-sm sm:leading-6" placeholder="Enter one URL per line..."></textarea>
                </div>
                <p class="mt-2 text-sm text-gray-400" id="url-count-container">
                    URL Count: <span id="url-count">0</span>
                </p>
            </div>
            <div class="mt-6 flex items-center justify-end gap-x-4">
                <button type="button" id="clear-btn" class="text-sm font-semibold leading-6 text-white">Clear</button>
                <button type="submit" id="submit-btn" class="rounded-md bg-indigo-500 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-500">
                    Start Download
                </button>
            </div>
        </form>
    </div>


    <!-- Active Downloads Table -->
    <div class="mt-8 flow-root">
        <div class="sm:flex sm:items-center mb-4">
            <div class="sm:flex-auto">
                <h2 class="text-base font-semibold leading-6 text-white">Download Queue</h2>
                <p class="mt-2 text-sm text-gray-300">List of active and pending downloads. The list updates automatically.</p>
            </div>
            <div class="mt-4 sm:ml-16 sm:mt-0 sm:flex-none">
                <button type="button" id="refresh-btn" class="block rounded-md bg-indigo-500 px-3 py-2 text-center text-sm font-semibold text-white shadow-sm hover:bg-indigo-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-500">
                    Refresh List
                </button>
            </div>
        </div>
        <div class="-mx-4 -my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
            <div class="inline-block min-w-full py-2 align-middle sm:px-6 lg:px-8">
                <table class="min-w-full divide-y divide-white/10">
                    <thead>
                        <tr>
                            <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-white sm:pl-6">Batch Name</th>
                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-white">Status</th>
                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-white">Progress</th>
                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-white">Files</th>
                            <th scope="col" class="relative py-3.5 pl-3 pr-4 sm:pr-6">
                                <span class="sr-only">View</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-white/10" id="downloads-tbody">
                        <!-- Rows will be injected by JavaScript -->
                         <tr><td colspan="5" class="text-center py-4 text-gray-500">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>


<!-- Progress Modal -->
<div id="progress-modal" class="hidden fixed inset-0 z-10 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-800 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        
        <div class="inline-block align-bottom bg-gray-900 rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full sm:p-6">
            <div>
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-white" id="modal-title">
                            Download Progress: <span id="modal-batch-name" class="font-bold"></span>
                        </h3>
                        <div class="mt-4">
                             <p class="text-sm text-gray-400" id="modal-stats"></p>
                             <div class="mt-2">
                                <div class="w-full bg-gray-700 rounded-full h-4">
                                    <div id="modal-progress-bar" class="bg-indigo-500 h-4 rounded-full text-xs font-medium text-white text-center p-0.5 leading-none" style="width: 0%;">0%</div>
                                </div>
                             </div>
                        </div>
                        <div class="mt-6">
                            <h4 class="text-md font-medium text-white">Files</h4>
                            <ul role="list" id="modal-files-list" class="mt-2 divide-y divide-white/10 max-h-96 overflow-y-auto">
                                <!-- File items will be injected by JavaScript -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-5 sm:mt-6">
                <button id="close-modal" type="button" class="inline-flex justify-center w-full rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:text-sm">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('download-form');
        const urlsTextarea = document.getElementById('urls');
        const urlCountSpan = document.getElementById('url-count');
        const submitBtn = document.getElementById('submit-btn');
        const clearBtn = document.getElementById('clear-btn');
        const refreshBtn = document.getElementById('refresh-btn');
        const progressModal = document.getElementById('progress-modal');
        const closeModalBtn = document.getElementById('close-modal');

        function createBadge(type, text) {
            const baseClasses = 'inline-flex items-center rounded-md px-2 py-1 text-xs font-medium ring-1 ring-inset ';
            if (type === 'success') return `<span class="${baseClasses} bg-green-500/10 text-green-400 ring-green-500/20">${text}</span>`;
            if (type === 'info') return `<span class="${baseClasses} bg-blue-400/10 text-blue-300 ring-blue-400/20">${text}</span>`;
            if (type === 'warning') return `<span class="${baseClasses} bg-yellow-400/10 text-yellow-300 ring-yellow-400/20">${text}</span>`;
            if (type === 'error') return `<span class="${baseClasses} bg-red-400/10 text-red-300 ring-red-400/20">${text}</span>`;
            return `<span class="${baseClasses} bg-gray-400/10 text-gray-300 ring-gray-400/20">${text}</span>`;
        }

        function getStatusBadge(status) {
            if (status === 'completed') return createBadge('success', 'Completed');
            if (status === 'downloading' || status === 'active') return createBadge('info', 'Downloading');
            if (status === 'failed') return createBadge('error', 'Failed');
            if (status === 'pending') return createBadge('warning', 'Pending');
            return createBadge('default', status);
        }
        
        function renderDownloadsTable(batches) {
            const tableBody = document.getElementById('downloads-tbody');
            tableBody.innerHTML = '';

            if (!batches || batches.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="5" class="text-center py-4 text-gray-500">No active or pending downloads.</td>`;
                tableBody.appendChild(row);
                return;
            }

            batches.forEach(batch => {
                const row = document.createElement('tr');
                row.setAttribute('data-batch-id', batch.id);

                const total_size_mb = (batch.total_size_bytes || 0) / (1024 * 1024);
                const downloaded_mb = (batch.downloaded_bytes || 0) / (1024 * 1024);
                const progress_percentage = (batch.progress_percentage || 0);

                row.innerHTML = `
                    <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-white sm:pl-6">${batch.batch_name}</td>
                    <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-400">${getStatusBadge(batch.status)}</td>
                    <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-400">
                        <div class="w-full bg-gray-700 rounded-full h-2.5">
                            <div class="bg-indigo-500 h-2.5 rounded-full" style="width: ${progress_percentage.toFixed(2)}%"></div>
                        </div>
                        <span class="text-xs text-gray-400 mt-1 block">${progress_percentage.toFixed(2)}%</span>
                        <span class="text-xs text-gray-400 mt-1 block">${downloaded_mb.toFixed(2)}MB / ${total_size_mb.toFixed(2)}MB</span>
                    </td>
                    <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-400">${batch.items_completed || 0} / ${batch.items_total || 0}</td>
                    <td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-6">
                        <button data-batch-id="${batch.id}" class="view-progress-btn text-indigo-400 hover:text-indigo-300">상세 보기</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function showProgressModal(batch) {
            document.getElementById('modal-batch-name').textContent = batch.batch_name;
            const modalTotalSize = (batch.total_size_bytes || 0) / (1024 * 1024);
            const modalDownloadedSize = (batch.downloaded_bytes || 0) / (1024 * 1024);
            const modalProgress = (batch.progress_percentage || 0);

            document.getElementById('modal-stats').textContent = 
                `${batch.items_completed || 0} / ${batch.items_total || 0} files completed | ${modalDownloadedSize.toFixed(2)} MB / ${modalTotalSize.toFixed(2)} MB`;
            
            const progressBar = document.getElementById('modal-progress-bar');
            progressBar.style.width = `${modalProgress.toFixed(2)}%`;
            progressBar.textContent = `${modalProgress.toFixed(2)}%`;
            
            const filesContainer = document.getElementById('modal-files-list');
            filesContainer.innerHTML = '';

            if (batch.items && batch.items.length > 0) {
                let filesHtml = batch.items.map(item => {
                    const itemSizeMB = item.total_size_bytes ? (item.total_size_bytes / (1024 * 1024)).toFixed(2) : 'N/A';
                    let itemStatusBadge = getStatusBadge(item.status);

                    return `
                        <li class="flex justify-between gap-x-6 py-3">
                            <div class="flex min-w-0 gap-x-4">
                                <div class="min-w-0 flex-auto">
                                    <p class="text-sm font-semibold leading-6 text-white truncate" title="${item.filename}">${item.filename}</p>
                                    <p class="mt-1 flex text-xs leading-5 text-gray-400">
                                        <span class="relative truncate">${itemSizeMB} MB</span>
                                    </p>
                                </div>
                            </div>
                            <div class="flex shrink-0 items-center gap-x-4">
                                ${itemStatusBadge}
                            </div>
                        </li>
                    `;
                }).join('');
                filesContainer.innerHTML = filesHtml;
            } else {
                filesContainer.innerHTML = `<li class="text-center py-4 text-gray-500">No files in this batch.</li>`;
            }

            progressModal.classList.remove('hidden');
        }

        async function loadActiveDownloads() {
            try {
                const response = await fetch('/api/download/batches?status=active,pending');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const batches = await response.json();
                renderDownloadsTable(batches);
            } catch (error) {
                console.error('Error fetching active downloads:', error);
                const tableBody = document.getElementById('downloads-tbody');
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-red-400">Failed to load downloads. Check console for errors.</td></tr>`;
            }
        }

        // --- Event Handlers ---
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            const urls = urlsTextarea.value
                .split(/[\r\n]+/)  // 다양한 줄바꿈 문자 처리
                .map(url => url.trim())
                .filter(url => url && url.length > 0);

            if (urls.length === 0) {
                alert('Please enter at least one URL.');
                return;
            }

            try {
                const response = await fetch('/api/download/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ urls })
                });
                if (!response.ok) throw new Error('Failed to start download.');
                
                urlsTextarea.value = '';
                updateUrlCount();
                loadActiveDownloads(); // Refresh list immediately
            } catch (error) {
                console.error('Error starting download:', error);
                alert('An error occurred. Please try again.');
            }
        });

        urlsTextarea.addEventListener('input', updateUrlCount);
        
        function updateUrlCount() {
            const count = urlsTextarea.value
                .split(/[\r\n]+/)
                .filter(url => url.trim().length > 0).length;
            urlCountSpan.textContent = count;
        }

        clearBtn.addEventListener('click', () => {
            urlsTextarea.value = '';
            updateUrlCount();
        });
        
        refreshBtn.addEventListener('click', loadActiveDownloads);

        closeModalBtn.addEventListener('click', () => {
            progressModal.classList.add('hidden');
        });

        document.getElementById('downloads-tbody').addEventListener('click', async function(e) {
            if (e.target.classList.contains('view-progress-btn')) {
                const batchId = e.target.getAttribute('data-batch-id');
                try {
                    const response = await fetch(`/api/download/batches/${batchId}`);
                    if (!response.ok) throw new Error('Batch not found.');
                    const batch = await response.json();
                    showProgressModal(batch);
                } catch (error) {
                    console.error('Error fetching batch details:', error);
                }
            }
        });

        // --- Initial Load ---
        loadActiveDownloads();

        // --- SSE for real-time updates ---
        const sse = new EventSource('/api/download/stream');
        sse.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.type === 'update') {
                loadActiveDownloads();
            }
        };
        sse.onerror = function(error) {
            console.error('SSE Error:', error);
            // Optional: Implement reconnection logic or notify user
        };

    });
</script>
{% endblock %}